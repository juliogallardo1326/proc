<?
###############################################################################
## PROGRAM     : Dopays.com - The First Open Source Payment Gateway          ##
## VERSION     : 2.80                                                        ##
## AUTHOR(S)   : Dmitry Pereuda, dmitry@pereuda.com                          ##
##               Oleg Ostaplyuck, oleg@ostaplyuk.com                         ##
## COMPANY     : Dosware Team                                                ##
## COPYRIGHTS  : (C)2003 Dosware Team. All Rights Reserved                   ##
##                                                                           ##
## LICENSE     : http://www.gnu.org/copyleft/gpl.html                        ##
###############################################################################
## Dopays  is free software;  you can redistribute it and/or modify it under ##
## the terms of the  GNU  General Public License as published  by  the  Free ##
## Software Foundation; either version 2 of the License, or (at your option) ##
## any later version.                                                        ##
##                                                                           ##
## Dopays is distributed in the hope that it will be useful, but WITHOUT ANY ##
## WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS ##
## FOR A PARTICULAR PURPOSE.  See the  GNU General Public License  for  more ##
## details.                                                                  ##
##                                                                           ##
## TO COMPLY WITH THIS LICENSE, PLEASE DO NOT REMOVE THE LINK TO THE DOSWARE ##
## WEBSITE FROM YOUR COPY OF THE SCRIPT.  THIS IS THE LEAST YOU  CAN  DO  TO ##
## SUPPORT THE DEVELOPMENT OF DOPAYS.COM!                                    ##
##                                                                           ##
## You should have received a copy of the  GNU  General Public License along ##
## with this program; if not, you can find it here:                          ##
##    http://www.gnu.org/copyleft/gpl.html                                   ##
## or write to the:                                                          ##
##    Free Software Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA ##
###############################################################################
$data['PageName']='MEMBER LOGIN';
$data['PageFile']='login';
###############################################################################
include('../config.htm');
###############################################################################
if(!$_SESSION['attempts'])$_SESSION['attempts']=0;
###############################################################################
if($post['send']){
   if($_SESSION['attempts']<$data['PassAtt']-1){
        if(!$post['username']){
                $data['Error']='Your username can not be empty.';
        }elseif(!$post['password']){
                $data['Error']='Your password can not be empty.';
        }elseif($data['UseTuringNumber']&&
                (!$post['turing']||strtoupper($post['turing'])!=$_SESSION['turing'])
        ){
                $data['Error']='Please enter valid turing number.';
        }elseif(!is_member_active($post['username'])){
                $data['Error']='This member was not found in the system. Or is inactive, banned or closed.';
        }elseif(!is_member_found($post['username'], $post['password'])){
           $data['Error']='Your have entered a wrong username or password.';
        }else{
			unset($_SESSION['attempts']);
			$_SESSION['uid']=get_member_id($post['username'], $post['password']);
			$_SESSION['login']=true;
			set_last_access($post['username']);
			save_remote_ip((int)$_SESSION['uid'], $_SERVER["REMOTE_ADDR"]);
			if($data['UseTuringNumber'])unset($_SESSION['turing']);
			header("Location:{$data['Host']}/members/index.htm");
			echo('ACCESS DENIED.');
			exit;
        }
        (int)$_SESSION['attempts']++;
   }else{
      if($data['UseTuringNumber'])unset($_SESSION['turing']);
      unset($_SESSION['attempts']);
      $data['CantLogin']=true;
   }
}
$data['attempts']=$_SESSION['attempts'];
###############################################################################
if($data['UseTuringNumber'])$_SESSION['turing']=gencode();
###############################################################################
display('members');
###############################################################################
?>