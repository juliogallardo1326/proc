{include file="header.tpl.html" extra_title=$extra_title}
{include file="navigation.tpl.html"}

<br />
{if $close_result != ""}
<table width="500" bgcolor="{$cell_color}" border="0" cellspacing="0" cellpadding="1" align="center">
  <tr>
    <td>
      <table bgcolor="#FFFFFF" width="100%" cellspacing="1" cellpadding="2" border="0">
        <tr>
          <td class="default">
            {if $close_result == -1}
            <b>Sorry, an error happened while trying to run your query.</b>
            {elseif $close_result == 1}
            <b>Thank you, the issue was closed successfully. Please choose
            from one of the options below:</b>
            <ul>
              <li><a href="view.php?id={$smarty.post.issue_id}" class="link">Open the Issue Details Page</a></li>
              <li><a href="list.php" class="link">Open the Issue Listing Page</a></li>
              {if $app_setup.support_email == 'enabled' and $current_role > $roles.viewer}
              <li><a href="emails.php" class="link">Open the Emails Listing Page</a></li>
              {/if}
            </ul>
            {/if}
          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
{else}
{literal}
<script language="JavaScript">
<!--
var has_per_incident_contract = false;

function validateClose(f)
{
    if (getSelectedOption(f, 'status') == -1) {
        selectField(f, 'status');
        alert('Please choose the new status for this issue.');
        return false;
    }
    if (isWhitespace(f.reason.value)) {
        selectField(f, 'reason');
        alert('Please enter the reason for closing this issue.');
        return false;
    }

    if (!isWhitespace(f.time_spent.value)) {
        if (!isNumberOnly(f.time_spent.value)) {
            selectField(f, 'time_spent');
            alert('Please enter integers (or floating point numbers) on the time spent field.');
            return false;
        }
        if (f.category.options[f.category.selectedIndex].value == '') {
            selectField(f, 'category');
            alert('Please choose the time tracking category for this new entry.');
            return false;
        }
    }

    if (has_per_incident_contract) {
        elements = getForm('close_form');
        has_checked_incident = false;
        for (i = 0; i < elements.length; i++) {
            if (elements[i].name.substr(0, 6) == 'redeem') {
                if (elements[i].checked == true) {
                    has_checked_incident = true;
                }
            }
        }
        if (has_checked_incident == false) {
            return confirm('This customer has a per incident contract. You have chosen not to redeem any incidents. Press \'OK\' ' +
             'to confirm or \'Cancel\' to revise.');
        }
    }
    return true;
}

function toggleNotificationList()
{
    var f = getForm('close_form');

    var cell = getPageElement('reason_cell');

    if (f.notification_list[1].checked) {
        cell.style.background = "{/literal}{$cell_color}{literal}";
    } else {
        cell.style.background = "{/literal}{$internal_color}{literal}";
    }
}
//-->
</script>
{/literal}
<table width="80%" bgcolor="{$cell_color}" border="0" cellspacing="0" cellpadding="1" align="center">
<form name="close_form" onSubmit="javascript:return validateClose(this);" method="post" action="close.php">
<input type="hidden" name="cat" value="close">
<input type="hidden" name="issue_id" value="{$smarty.get.id}">
  <tr>
    <td>
      <table bgcolor="#FFFFFF" width="100%" cellspacing="1" cellpadding="2" border="0">
        <tr>
          <td colspan="2" class="default" nowrap>
            <b>Close Issue</b> (Issue ID: {$smarty.get.id})
          </td>
        </tr>
        <tr>
          <td width="160" bgcolor="{$cell_color}" class="default_white">
            <b>Status: *</b><br />
          </td>
          <td bgcolor="{$light_color}">
            <select class="default" name="status">
              <!--option value="-1">Please choose a status</optio-->
              {html_options options=$statuses}
            </select>
            <script language="Javascript">selectOnlyValidOption(document.forms['close_form'].elements['status']);</script>
            {include file="error_icon.tpl.html" field="status"}
          </td>
        </tr>
        {if $resolutions|@count > 0}
        <tr>
          <td width="160" bgcolor="{$cell_color}" class="default_white">
            <b>Resolution:</b><br />
          </td>
          <td bgcolor="{$light_color}">
            <select class="default" name="resolution">
              {html_options options=$resolutions}
            </select>
          </td>
        </tr>
        {else}
            <input type="hidden" name="resolution" value="">
        {/if}
        <tr>
          <td width="160" bgcolor="{$cell_color}" class="default_white">
            <b>Send Notification About Issue Being Closed?</b><br />
          </td>
          <td bgcolor="{$light_color}" class="default">
            <input type="radio" name="send_notification" checked value="1">
            <a id="link" class="link" href="javascript:void(null);" onClick="javascript:checkRadio('close_form', 'send_notification', 0);">Yes</a>&nbsp;&nbsp;
            <input type="radio" name="send_notification" value="0">
            <a id="link" class="link" href="javascript:void(null);" onClick="javascript:checkRadio('close_form', 'send_notification', 1);">No</a>
          </td>
        </tr>
        <tr>
          <td width="160" bgcolor="{$cell_color}" class="default_white">
            <b>Send Notification To:</b><br />
          </td>
          <td bgcolor="{$light_color}" class="default">
            <input id="notification_internal" type="radio" name="notification_list" checked value="internal" onchange="toggleNotificationList()">
            <label for="notification_internal">Internal Users ({$notification_list_internal|default:"<i>None</i>"})</label><br />
            <input id="notification_all" type="radio" name="notification_list" value="all" onchange="toggleNotificationList()">
            <label for="notification_all">All ({$notification_list_all|default:"<i>None</i>"})</label>
          </td>
        </tr>
        <tr>
          <td width="160" bgcolor="{$internal_color}" class="default_white" id="reason_cell">
            <b>Reason for closing issue: *</b><br />
          </td>
          <td bgcolor="{$light_color}" class="default">
            <textarea name="reason" rows="8" style="width: 97%"></textarea>
            {include file="error_icon.tpl.html" field="reason"}
          </td>
        </tr>
        {if $incident_details|@count > 0}
        <script>
        has_per_incident_contract = true;
        </script>
        <tr>
          <td width="160" bgcolor="{$internal_color}" class="default_white">
            <b>Incident Types to Redeem: </b><br />
          </td>
          <td bgcolor="{$light_color}" class="default">
            {foreach from=$incident_details item=type_details key=type_id}
              {cycle values=$cycle assign="row_color"}
              {if $res == ''}<input type="checkbox" name="redeem[{$type_id}]" value="1" {if $redeemed[$type_id].is_redeemed == 1}checked{/if}>{/if}
              <a id="link" class="link" href="javascript:void(null);" onClick="javascript:toggleCheckbox('close_form', 'redeem[{$type_id}]', 0);">{$type_details.title} (Total: {$type_details.total}; Left: {$type_details.total-$type_details.redeemed})</a><br />
            {/foreach}
          </td>
        </tr>
        {/if}
        <tr>
          <td width="160" bgcolor="{$internal_color}" class="default_white">
            <b>Time Spent: </b><br />
          </td>
          <td bgcolor="{$light_color}">
            <input class="default" type="text" size="5" name="time_spent" class="default"> <span class="default">(in minutes)</span>{include file="error_icon.tpl.html" field="time_spent"}
          </td>
        </tr>
        <tr>
          <td width="160" bgcolor="{$internal_color}" class="default_white">
            <b>Time Category: </b><br />
          </td>
          <td bgcolor="{$light_color}">
            <select name="category" class="default">
              <option value="">Please choose a category</option>
              {html_options options=$time_categories}
            </select>
            {include file="error_icon.tpl.html" field="category"}
          </td>
        <tr bgcolor="{$cell_color}">
          <td colspan="2">
            <table cellpadding="0" cellspacing="0" border="0" width="100%">
              <tr>
                <td><input class="button" type="button" value="&lt;&lt; Back" onClick="javascript:history.go(-1);"></td>
                <td width="100%" align="center"><input class="button" type="submit" value="Close Issue"></td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
    </td>
  </tr>
</form>
</table>
{/if}
<br />

{include file="app_info.tpl.html"}
{include file="footer.tpl.html"}